== ACME Music Player - Architecture Playground

image::.github/badges/jacoco.svg[Line Coverage]
image::.github/badges/branches.svg[Branch Coverage]

Spielwiese für Architektur-Experimente.

:toc:

=== aktueller Stand

* 3 Module/Komponenten
** Users
** Musicplayer
** Scoreboard
* Cucumber basierte Komponententests
* Datenbankmigration mit Liquibase, Java Modell Generierung mittels JOOQ
** kein JPA: JOOQ-basierte Datenbankzugriffe mittels JDBC
* maximal parallele, unabhängige Tests
* Event Driven
* Frontend mittels HTMX, Halfmoon CSS und Server Sent Events (SSE)
* Spring Native getestet und verworfen (siehe <<Erkenntnisse/ADRs>> )

=== ungefähres Zielbild als "Spielwiese"

* keine neue Funktionalität
* minimal lauffähiger Prototyp mit etwas Funktionalität
** ein Benutzer kann sich registrieren (User Komponente) und beliebig Lieder hochladen, auflisten und abspielen (Musicplayer Komponente)
** der Benutzer mit den meisten hochgeladenen Liedern bekommt eine "Auszeichnung" (Scoreboard Komponente)
* 3 Module
** ein Microservice
** ein Modulith mit 2 Komponenten

Marks: ❓ ❌ ✅

== Aufbau

image::acme-aufbau.drawio.png[Acme Aufbau,100%]

== TODO

Features:

. MP3 abspielen ✅
. Registrieren ✅
.. Login gefaked durch Registrierung (kein separater Login) ✅
. Spring Native ✅
. Modulith ✅
. Scoreboard score board ✅
.. Dritter event Driven service ✅
.. Basis für längerlaufende Testdaten
.. Events mit Value Objects aus der Domain oder Plain Objects!?
.. Nachvollziehbarkeit/Dokumentation welche Events von wo nach wo?
. Event und Prozessdokumentation [❓]
.. In event Bibliothek test ob events alle in der Readme auftauchen
.. In der Readme draw io Bild mit event und Prozess?
. Event Bibliothek [❓]
.. Inbox und outbox pattern
.. Dokumentation von Event zu Service Zugehörigkeit?
. Testdaten Spike [❓]
.. Tenant in Entity aufnehmen
.. Events in Entity aufnehmen und transaktional speichern

== Erkenntnisse/ADRs

- xref:documentation/01-spring-native.adoc[Spring Native]
- xref:documentation/02-testing-framework.adoc[Testing Framework]

== Ideen

=== Paralleles Testing ermöglichen ✅

. Daten nur explizit anlegen
.. UUID am Szenarioanfang im Test
... A) spezifische Testdaten: ❌
.... testdata-UUID()@testdata.local
.... testdata-UUID().mp3
... B) "Tenant" ✅
.... alle Usecase Commands um "Tenant" Parameter erweitern
..... Default "1" oder "GLOBAL"
.... Repos/Indizes nach Tenant-Id umbauen
.. in AfterAll löschen aller Testdaten anhand des Tenants ✅
... Admin-Usecase zum Löschen?

=== Modulith  ✅

. zweites Modul erstellen
. test2test kommunikation wie?
Async App Listener?
Fake Antworten/Events
. test2real == end to end test mit MessageBroker?
. Feature Test kann ja bestehen bleiben, je nach Modul andere Steps, aber Steps die für das Modul irrelevant sind -> NOOP.
Geht das?
. ArchUnit?
. Zugriff von einem Modul auf Model anderes Moduls verbieten?
. Usecase darf anderen Usecase in anderem Modul aufrufen, aber der Usecase gibt ein internes Domainobjekt zurück, ist das problematisch?
In zwei Microservices gesplittet, wäre das Objekt ein DTO und hätte keine "Extra-Logik".
Annahme: wenn aus dem Modulithen zwei Microservices werden, muss das beachtet werden.
Vermutlich werden dann die Getter einfach im Controller aufgerufen und die "Extra-Logik" findet bei der Umwandlung zum DTO für die API automatisch statt.

=== Testdaten in komplexen Fachprozessen  ❓

Wie können Tests geschrieben werden, welche sich am Ende eines komplexen fachlichen Prozesses befinden?

. Fachlich korrekte Testdatenbuilder schreiben
.. Gefahr der Re-Implementierung der Businesslogik im Testcode -> schlecht
.. Wiederverwendung von Businesslogik möglich?
.. Erzwingt Datenbankzugriff an Usecases vorbei im Testcode
... zwingende Wiederverwendung der Domain-Objekte
. Snapshot bzw.
Backup/Restore Funktionalität für ein Szenario
.. Szenario 1 laufen lassen
.. Ergebnis von Szenario 1 snappshotten
.. in Szenario 2 Snapshot wiederverwenden
.. es entstehen Abhängigkeiten zwischen den Szenarien
. Testszenarien entlang der Prozesse schneiden und nicht einzelner Features
.. Statt "MP3 abspielen", "User Einloggen" als einzelne Szenarien, ein Szenario für den Prozess des Musikabspielens "User registriert sich, user loggt sich ein, user lädt MP3 hoch, user spielt MP3 ab" in einem Szenario
.. Gegebenenfalls natürlich in sinnvoll Szenarien schneiden, wenn es zu komplex wird
... "User spielt Lied direkt ab", "User spielt Lied in Playlist ab", "User teilt Playlist mit Freunden"

== Quickstart

=== Java

JDK 21 für normale Entwicklung,

[source,bash]
--
sdk install java 21.0.2-tem
sdk use java 21.0.2-tem
--

=== DB neu aufsetzen und Modell generieren

[source,bash]
--
./mvnw io.brachu:docker-compose-maven-plugin:up@run-docker org.liquibase:liquibase-maven-plugin:dropAll org.liquibase:liquibase-maven-plugin:update org.jooq:jooq-codegen-maven:generate

--

=== Test

startet auch docker container

[source,bash]
--
./mvnw clean test
--

=== Run

[source,bash]
--
./mvnw docker-compose:up@run-docker
./mvnw spring-boot:run
--

=== Run Spring Native

Hinweis: Jooq benötigt extra Instrumentation (oder automatisches Tracing), siehe https://github.com/jOOQ/jOOQ/issues/8779

JDK 23, NIK 24 (Native image.
JDK 21 sollte auch einfach gehen)

==== Compiling
[source,bash]
--
sdk install java 24.1.1.r23-nik
sdk use java 24.1.1.r23-nik
./mvnw -Pnative native:compile
--

==== Native Running

[source,bash]
--
./target/acme
--


//
// == Usecases
//
// [plantuml, format=svg, opts="inline"]
// --
//
// left to right direction
//
// actor Nutzer
//
// package "Music Player" {
//   usecase "Lied hören"
//   usecase "Lied hochladen"
//   usecase "Lied löschen" #green
// }
//
// package "User Management" {
//   usecase "Registrieren"
//   usecase "Benutzer erhält Auszeichnung"
//   usecase "Benutzer löschen" #green
// }
//
// package "Scoreboard" {
//   usecase "Scores löschen" #green
// }
//
// Nutzer ----> "Registrieren"
// Nutzer ----> "Lied hochladen" : eigene Lieder (privat)
// Nutzer ----> "Lied hören"
// Nutzer ----> "Lied löschen"
// Nutzer ----> "Benutzer erhält Auszeichnung"
//
//
// actor Admin #green
// Admin -u-> "Benutzer löschen"
// Admin -u-> "Lied löschen"
// Admin -u-> "Scores löschen"
// --
